name: Build Plugin

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'  # This will trigger on any tag that starts with 'v'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  MAJOR_VERSION: 10
  MINOR_VERSION: 0
  PATCH_VERSION: 2
  PLUGIN_NAME: Lidarr.Plugin.Tidal
  MINIMUM_LIDARR_VERSION: 2.2.4.4129
  DOTNET_VERSION: 8.0.404
  FRAMEWORK: net6.0
  RUNTIME: win-x64

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Set version for tags
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        TAG_VERSION=${GITHUB_REF#refs/tags/v}
        echo "PLUGIN_VERSION=$TAG_VERSION" >> $GITHUB_ENV
    
    - name: Get build number
      if: ${{ !startsWith(github.ref, 'refs/tags/') }}
      id: build_number
      run: |
        if [ -f .github/workflows/.build_number ]; then
          echo "BUILD_NUMBER=$(cat .github/workflows/.build_number)" >> $GITHUB_ENV
        else
          echo "BUILD_NUMBER=1" >> $GITHUB_ENV
        fi
    
    - name: Set version for non-tags
      if: ${{ !startsWith(github.ref, 'refs/tags/') }}
      run: |
        echo "PLUGIN_VERSION=${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ env.PATCH_VERSION }}.${{ env.BUILD_NUMBER }}" >> $GITHUB_ENV
    
    - name: Build
      run: |
        echo "Building version ${{ env.PLUGIN_VERSION }}"
        
        dotnet publish src/${{ env.PLUGIN_NAME }}/${{ env.PLUGIN_NAME }}.csproj \
          -c Release \
          -f ${{ env.FRAMEWORK }} \
          -r ${{ env.RUNTIME }} \
          --self-contained false \
          -p:Version=${{ env.PLUGIN_VERSION }} \
          -o _output
    
    - name: Package
      run: |
        mkdir -p _output/${{ env.PLUGIN_NAME }}
        mv _output/*.dll _output/${{ env.PLUGIN_NAME }}/ 2>/dev/null || true
        mv _output/*.json _output/${{ env.PLUGIN_NAME }}/ 2>/dev/null || true
        mv _output/*.config _output/${{ env.PLUGIN_NAME }}/ 2>/dev/null || true
        
        mkdir -p _artifacts
        cd _output
        zip -r ../_artifacts/${{ env.PLUGIN_NAME }}.${{ env.FRAMEWORK }}.zip ${{ env.PLUGIN_NAME }}
        cd ..
        ls -la _artifacts/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}
        path: _artifacts/${{ env.PLUGIN_NAME }}.${{ env.FRAMEWORK }}.zip
        if-no-files-found: error

    - name: Debug file existence
      run: |
        pwd
        ls -la
        ls -la _artifacts/
        echo "Checking for file: _artifacts/${{ env.PLUGIN_NAME }}.${{ env.FRAMEWORK }}.zip"
        if [ -f "_artifacts/${{ env.PLUGIN_NAME }}.${{ env.FRAMEWORK }}.zip" ]; then
          echo "File exists"
        else
          echo "File does not exist"
          exit 1
        fi

    - name: Generate Changelog
      id: changelog
      run: |
        echo "# ${{ env.PLUGIN_VERSION }}" > changelog.txt
        echo "" >> changelog.txt
        echo "## Changes in this release:" >> changelog.txt
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "HEAD~10")
          git log --oneline ${PREVIOUS_TAG}..HEAD | awk '{print "- " substr($0, index($0,$2))}' >> changelog.txt
        else
          git log --oneline $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")..HEAD | awk '{print "- " substr($0, index($0,$2))}' >> changelog.txt
        fi
        cat changelog.txt

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: ${{ startsWith(github.ref, 'refs/tags/') || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
      with:
        tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', env.PLUGIN_VERSION) }}
        name: Version ${{ env.PLUGIN_VERSION }}
        body_path: changelog.txt
        draft: false
        prerelease: false
        files: _artifacts/${{ env.PLUGIN_NAME }}.${{ env.FRAMEWORK }}.zip
    
    - name: Increment build number
      if: ${{ !startsWith(github.ref, 'refs/tags/') && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
      run: |
        echo "$((BUILD_NUMBER + 1))" > .github/workflows/.build_number
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add .github/workflows/.build_number
        git commit -m "Increment build number to $((BUILD_NUMBER + 1)) [skip ci]"
        git push





