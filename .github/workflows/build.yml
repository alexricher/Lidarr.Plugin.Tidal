name: Build Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  MAJOR_VERSION: 10
  MINOR_VERSION: 0
  PATCH_VERSION: 2
  PLUGIN_NAME: Lidarr.Plugin.Tidal
  MINIMUM_LIDARR_VERSION: 2.2.4.4129
  DOTNET_VERSION: 8.0.404
  FRAMEWORK: net6.0
  RUNTIME: win-x64

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Get build number
      id: build_number
      run: |
        if [ -f .github/workflows/.build_number ]; then
          echo "BUILD_NUMBER=$(cat .github/workflows/.build_number)" >> $GITHUB_ENV
        else
          echo "BUILD_NUMBER=1" >> $GITHUB_ENV
        fi
    
    - name: Build
      run: |
        VERSION="${{ env.MAJOR_VERSION }}.${{ env.MINOR_VERSION }}.${{ env.PATCH_VERSION }}.${{ env.BUILD_NUMBER }}"
        echo "Building version $VERSION"
        
        dotnet publish src/${{ env.PLUGIN_NAME }}/${{ env.PLUGIN_NAME }}.csproj \
          -c Release \
          -f ${{ env.FRAMEWORK }} \
          -r ${{ env.RUNTIME }} \
          --self-contained false \
          -p:Version=$VERSION \
          -o _output
    
    - name: Package
      run: |
        mkdir -p _output/${{ env.PLUGIN_NAME }}
        mv _output/* _output/${{ env.PLUGIN_NAME }}/ 2>/dev/null || true
        
        mkdir -p _artifacts
        cd _output
        zip -r ../_artifacts/${{ env.PLUGIN_NAME }}.${{ env.FRAMEWORK }}.zip ${{ env.PLUGIN_NAME }}
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}
        path: _artifacts/${{ env.PLUGIN_NAME }}.${{ env.FRAMEWORK }}.zip
    
    - name: Increment build number
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "$((BUILD_NUMBER + 1))" > .github/workflows/.build_number
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add .github/workflows/.build_number
        git commit -m "Increment build number to $((BUILD_NUMBER + 1)) [skip ci]"
        git push
